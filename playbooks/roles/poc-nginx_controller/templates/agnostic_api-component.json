{
  "metadata": {
    "name": "{{ item.name | lower }}",
    "displayName": "{{ item.name | lower }} - Claim filtering",
    "description": "Generated by CMP"
  },
  "desiredState": {
    "ingress": {
      "uris": {
        {%- for api_path in var_paths -%}
          "{{ api_path }}": {}{%- if not loop.last -%},{% endif %}
        {%- endfor -%}
      },
      "gatewayRefs": [
        {
          "ref": "/services/environments/{{ var_env_prefix }}{{ extra_app.environment | lower }}/gateways/gw_{{extra_app.name | lower}}"
        }
      ]
    },
    "errorSetRef": {
      "links": {
        "rel": "/api/v1/services/errorsets/default-json",
        "displayName": "Default JSON ErrorSet",
        "name": "default-json"
      },
      "ref": "/services/errorsets/default-json"
    },
    "backend": {
      "ntlmAuthentication": "DISABLED",
      "preserveHostHeader": "DISABLED",
      "workloadGroups": {
        "wlg_{{ item.name | lower }}": {
          "loadBalancingMethod": {
            "type": "LEAST_CONNECTIONS"
          },
          "sessionPersistence": {
            "type": "COOKIE"
          },
          "uris": {
            {%- for workload in item.workloads -%}
            "https://{{ workload }}": {
              {%- if loop.index == 1 %}
                "isBackup": false,
              {% else %}
                "isBackup": true,
              {% endif -%}
              "isDown": false,
              "isDrain": false
            }{%- if not loop.last -%},{% endif %}
            {%- endfor -%}
          }
        }
      },
      "monitoring": {
        "defaultState": "HEALTHY",
        "interval": 5,
        "consecutiveSuccessThreshold": 3,
        "consecutiveFailureThreshold": 3,
        "uri": "{{ item.monitor_uri }}",
        "response": {
          "status": {
            "range": {
              "startCode": 400,
              "endCode": 409
            },
            "match": true
          }
        }
      }
    },
    "logging": {
      "errorLog": "ENABLED",
      "accessLog": {
        "state": "ENABLED"
      }
    },
    "security": {
      "rateLimits": {
        "policy_1": {
          "rate": "100r/m",
          "burstBeforeDelay": 0,
          "statusCode": 429,
          "key": "$request_uri_path"
        }
      },
      "identityProviderRefs": [
        {"ref": "/security/identity-providers/idp_{{ extra_app.name | lower }}"}
       ],
      "jwtClientAuth": {
        "keyLocation": "BEARER"
      },
      "conditionalAuthPolicies": {
        "allow_client_id": {
          "sourceType": "JWT_CLAIM",
          "sourceKey": "{{ extra_app.claim }}",
          "comparisonType": "EQUALS",
          "comparisonValues": ["allow"],
          "action": "ALLOW",
          "denyStatusCode": 401
        }
      }
    },
    "programmability": {
      "httpHttpsRedirect": "ENABLED",
      "requestHeaderModifications": [
        {
          "action": "ADD",
          "headerName": "X-F5-Auth-Token",
          "headerValue": "{{ stats_bigip_token }}"
        },
        {
          "action": "ADD",
          "headerName": "Host",
          "headerValue": "bigip"
        }
      ]
    },
    "publishedApiRefs": [
      {
        "ref": "/services/environments/{{ var_env_prefix }}{{ extra_app.environment | lower }}/apps/app_{{extra_app.name | lower}}.{{extra_app.domain | lower}}/published-apis/api_{{ extra_app.name | lower }}_{{ item.name | lower}}"
      }
    ]
  }
}